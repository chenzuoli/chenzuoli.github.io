<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="msvalidate.01" content="F129FD2F3DAF3B4E8D4BB73786E3655C"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/fourleafclover-32x32.png?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/fourleafclover-16x16.png?v=5.1.3"><link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222"><meta name="keywords" content="Flink,Hbase,"><link rel="alternate" href="/atom.xml" title="chenzuoli's blog" type="application/atom+xml"><meta name="description" content="今天说下我在数据接入过程中遇到的一个奇葩的数据一致性的问题，就是在flink删除hbase数据的时候，返回了上一版本的数据，而不是直接删除。"><meta property="og:type" content="article"><meta property="og:title" content="Flink实时数仓第二篇"><meta property="og:url" content="https://chenzuoli.github.io/2021/07/17/Flink%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E7%AC%AC%E4%BA%8C%E7%AF%87/index.html"><meta property="og:site_name" content="chenzuoli&#39;s blog"><meta property="og:description" content="今天说下我在数据接入过程中遇到的一个奇葩的数据一致性的问题，就是在flink删除hbase数据的时候，返回了上一版本的数据，而不是直接删除。"><meta property="og:locale"><meta property="og:image" content="https://chenzuoli.github.io/2021/07/17/Flink%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E7%AC%AC%E4%BA%8C%E7%AF%87/flink-header-logo.svg"><meta property="og:image" content="https://chenzuoli.github.io/2021/07/17/Flink%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E7%AC%AC%E4%BA%8C%E7%AF%87/iceberg.png"><meta property="og:image" content="https://chenzuoli.github.io/images/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%86%99%E4%B9%A6%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BA%8C%E7%BB%B4%E7%A0%81.jpg"><meta property="og:image" content="https://chenzuoli.github.io/images/%E7%94%B5%E5%B7%B4%E5%85%8B%E5%AE%A0%E7%89%A9Pets%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BA%8C%E7%BB%B4%E7%A0%81.png"><meta property="article:published_time" content="2021-07-17T01:49:49.000Z"><meta property="article:modified_time" content="2021-07-17T01:49:49.000Z"><meta property="article:author" content="Lee"><meta property="article:tag" content="Flink"><meta property="article:tag" content="Hbase"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://chenzuoli.github.io/2021/07/17/Flink%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E7%AC%AC%E4%BA%8C%E7%AF%87/flink-header-logo.svg"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"",scheme:"Mist",version:"5.1.3",sidebar:{position:"right",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://chenzuoli.github.io/2021/07/17/Flink实时数仓第二篇/"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-6592717531467819",enable_page_level_ads:!0})</script><script data-ad-client="ca-pub-6592717531467819" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.5.2/animate.min.css"><script src="https://cdn.jsdelivr.net/npm/jquery@3.2/dist/jquery.min.js"></script><style>.floating-card-right{position:fixed;bottom:12%;right:10px;width:200px;z-index:9999}</style><div class="floating-card-right animate__animated animate__fadeInRight"><a href="https://lezhifu.cc" target="_blank"><div class="card"><div class="card-content"><span class="card-title">乐知付加密服务平台</span><p>如果你有资源， 平台可以帮你实现内容变现， 无需搭建知识付费服务平台。</p></div><div class="card-action text-left"><a href="https://lezhifu.cc" target="_blank">点击访问官方网站</a> <span>https://lezhifu.cc</span></div><br><div class="card-action text-center"><span>扫码关注公众号</span> <img width="50%" height="50%" src="/images/qrcode_lezhifu.jpg" alt="乐知付加密服务平台-微信公众号"></div></div></a></div><title>Flink实时数仓第二篇 | chenzuoli's blog</title><meta name="generator" content="Hexo 6.0.0"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><a target="_blank" rel="noopener" href="https://github.com/chenzuoli" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#64ceaa;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">chenzuoli's blog</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Focus on truth. welcome to correct.</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-top"><a href="/top/" rel="section"><i class="menu-item-icon fa fa-fw fa-signal"></i><br>阅读排行</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>RSS</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://chenzuoli.github.io/2021/07/17/Flink%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E7%AC%AC%E4%BA%8C%E7%AF%87/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content=""><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="chenzuoli's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Flink实时数仓第二篇</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-17T09:49:49+08:00">2021-07-17 </time><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于&#58;</span> <time title="更新于" itemprop="dateModified" datetime="2021-07-17T09:49:49+08:00">2021-07-17 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span> </a></span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据仓库</span> </a></span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/Flink/" itemprop="url" rel="index"><span itemprop="name">Flink</span> </a></span></span><span id="/2021/07/17/Flink%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E7%AC%AC%E4%BA%8C%E7%AF%87/" class="leancloud_visitors" data-flag-title="Flink实时数仓第二篇"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数&#58;</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-divider">|</span> <span class="page-pv"><i class="fa fa-file-o"></i> 浏览量 <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>今天说下我在数据接入过程中遇到的一个奇葩的数据一致性的问题，就是在flink删除hbase数据的时候，返回了上一版本的数据，而不是直接删除。</p><span id="more"></span><p><img src="/2021/07/17/Flink%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E7%AC%AC%E4%BA%8C%E7%AF%87/flink-header-logo.svg"></p><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">centos7.4</span><br><span class="line">jdk1.8</span><br><span class="line">flink 1.12.1</span><br><span class="line">hbase 1.4.13</span><br><span class="line">hadoop 2.7.4</span><br><span class="line">zookeeper 3.4.10</span><br></pre></td></tr></table></figure><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>通过mysql-cdc和hbase-1.4 connector，直接将数据写入hbase，两个sql如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">// create mysql-cdc table</span><br><span class="line">CREATE TABLE packageSourceTable (</span><br><span class="line">  ID int,</span><br><span class="line">  PACKAGE_ID int,</span><br><span class="line">  GAME_ID int,</span><br><span class="line">  CHANNEL_ID int,</span><br><span class="line">  PLATFORM int,</span><br><span class="line">  POPULARIZE int,</span><br><span class="line">  COMPANY_ID int</span><br><span class="line">) with (</span><br><span class="line"> &#x27;connector&#x27; = &#x27;mysql-cdc&#x27;,</span><br><span class="line"> &#x27;hostname&#x27; = &#x27;xxx&#x27;,</span><br><span class="line"> &#x27;port&#x27; = &#x27;3306&#x27;,</span><br><span class="line"> &#x27;username&#x27; = &#x27;xxx&#x27;,</span><br><span class="line"> &#x27;password&#x27; = &#x27;xxx&#x27;,</span><br><span class="line"> &#x27;database-name&#x27; = &#x27;game_platform&#x27;,</span><br><span class="line"> &#x27;table-name&#x27; = &#x27;packages&#x27;,</span><br><span class="line"> &#x27;server-time-zone&#x27; = &#x27;Asia/Shanghai&#x27;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// create hbase table</span><br><span class="line">CREATE TABLE hTable (</span><br><span class="line"> rowkey INT,</span><br><span class="line"> column_family ROW&lt;</span><br><span class="line">  ID int,</span><br><span class="line">  PACKAGE_ID int,</span><br><span class="line">  GAME_ID int,</span><br><span class="line">  CHANNEL_ID int,</span><br><span class="line">  PLATFORM int,</span><br><span class="line">  POPULARIZE int,</span><br><span class="line">  COMPANY_ID int&gt;,</span><br><span class="line"> PRIMARY KEY (rowkey) NOT ENFORCED</span><br><span class="line">) WITH (</span><br><span class="line"> &#x27;connector&#x27; = &#x27;hbase-1.4&#x27;,</span><br><span class="line"> &#x27;table-name&#x27; = &#x27;mytable&#x27;,</span><br><span class="line"> &#x27;zookeeper.quorum&#x27; = &#x27;localhost:2181&#x27;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// insert into hbase</span><br><span class="line">INSERT INTO hTable</span><br><span class="line">select</span><br><span class="line">  id as rowkey,</span><br><span class="line">  row(ID, PACKAGE_ID, GAME_ID, CHANNEL_ID, PLATFORM, POPULARIZE, COMPANY_ID);</span><br></pre></td></tr></table></figure><p>ok，上述三个sql分别在sql-client中执行，就可以直接把mysql的更新、删除、插入操作实时同步到hbase了，然后如果需要的话，建一个hive外表，通过sql做数据分析用。</p><p>在进行数据一致性校验的时候，发现在mysql端，如果某一条数据被更新了好几次，然后再删除，在hbase这边出现的情况是，更新操作正常，删除操作hbase直接回到最后一次更新之前的记录，非常的奇怪。</p><p>于是试了hbase shell的更新删除和java api的更新删除操作，均不会出现此类情况。</p><p>于是把重心转移到hbase身上，因为hbase存储机制有一些特殊，LSM架构让Hbase存在一些特殊情况，每条增删改记录都是在原数据的基础上进行拼接了新的记录，并根据主键做好标记（Insert Delete_Before Update_Before Update_After），每个Region包含多个Store，Store中包含一个MemStore和多个StoreFile，一个列簇对应一个Store，数据的增删改先存储在MemStore中，MemStore达到一定的数据量后，会flush到StoreFile，当StoreFile达到一定数据量和大小后，会进行compact，此时才是真正的合并数据，将delete的和更新前的，版本失效、过期的数据移除掉。</p><p>当时是这样分析的，flink删除hbase数据时，只删除了memstore中的最高版本的数据，低版本的数据仍然还在内存中，于是建hbase表时指定版本为1，只有一个版本，但是仍然出现以上问题。<br>于是继续猜测，可能是因为memstore没有flush和compact，导致内存中一直存在更新和删除的历史记录，于是在做完多次更新之后，进行一次手动flush和compact操作，果然flink可以删除成功了。</p><p>那怎么办呢？就去研究flink hbase connector如何进行flush compact操作了，发现了三个参数，跟flush有关，如下：</p><table><thead><tr><th>parameter</th><th>required</th><th>default</th><th>type</th><th>description</th></tr></thead><tbody><tr><td>sink.buffer-flush.max-size</td><td>optional</td><td>2mb</td><td>MemorySize</td><td>Writing option, maximum size in memory of buffered rows for each writing request. This can improve performance for writing data to HBase database, but may increase the latency. Can be set to ‘0’ to disable it.</td></tr><tr><td>sink.buffer-flush.max-rows</td><td>optional</td><td>1000</td><td>Integer</td><td>Writing option, maximum number of rows to buffer for each writing request. This can improve performance for writing data to HBase database, but may increase the latency. Can be set to ‘0’ to disable it.</td></tr><tr><td>sink.buffer-flush.interval</td><td>optional</td><td>1s</td><td>Duration</td><td>Writing option, the interval to flush any buffered rows. This can improve performance for writing data to HBase database, but may increase the latency. Can be set to ‘0’ to disable it. Note, both ‘sink.buffer-flush.max-size’ and ‘sink.buffer-flush.max-rows’ can be set to ‘0’ with the flush interval set allowing for complete async processing of buffered actions.</td></tr></tbody></table><p>于是加上了这几个参数，设置的是每来一条数据就刷一条，但是不管用，哭。。。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// create hbase table</span><br><span class="line">CREATE TABLE hTable (</span><br><span class="line"> rowkey INT,</span><br><span class="line"> column_family ROW&lt;</span><br><span class="line">  ID int,</span><br><span class="line">  PACKAGE_ID int,</span><br><span class="line">  GAME_ID int,</span><br><span class="line">  CHANNEL_ID int,</span><br><span class="line">  PLATFORM int,</span><br><span class="line">  POPULARIZE int,</span><br><span class="line">  COMPANY_ID int&gt;,</span><br><span class="line"> PRIMARY KEY (rowkey) NOT ENFORCED</span><br><span class="line">) WITH (</span><br><span class="line"> &#x27;connector&#x27; = &#x27;hbase-1.4&#x27;,</span><br><span class="line"> &#x27;table-name&#x27; = &#x27;mytable&#x27;,</span><br><span class="line"> &#x27;zookeeper.quorum&#x27; = &#x27;localhost:2181&#x27;,</span><br><span class="line"> &#x27;sink.buffer-flush.max-rows&#x27; = &#x27;1&#x27;,</span><br><span class="line"> &#x27;sink.buffer-flush.interval&#x27; = &#x27;1s&#x27;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>最后实在没办法，想到既然自己写的java api操作hbase增删改数据一致性没问题，那么是不是看看flink hbase connector如何操作的，改掉它不就行了，connector也是java写的。<br>于是走到了修改源码的道路，按照自己写的java api操作hbase 的方法修改了源码，重新打包，但是依然不见效果，绝了，无语了，放弃了。</p><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>上面的问题，一度困扰了我三天时间，都怀疑这条路是否能行得通了，最后终于放弃了，转向研究其他实时数仓路线，了解到Flink+iceberg能做到近实时，于是开始尝试了，iceberg目前还在发展中，没有稳定版本，我现在看的iceberg适配flink1.11.x，前面我用的是flink1.12.1，所以需要降低版本。<br><img src="/2021/07/17/Flink%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E7%AC%AC%E4%BA%8C%E7%AF%87/iceberg.png" alt="iceberg_flink"><br>于是下载了flink1.11.3，停掉了原来的flink，在同一台机器上，修改了FLINK_HOME，启动了1.11.3的flink，按照iceberg官档操作起来了。<br>晚上回去还是有些对Hbase路线不甘心，想去一探究竟到底是啥原因引起的，继续看源码，继续尝试，上次修改了源码，不知道有没有生效，这次打上日志，运行看看是不是真的走这里，进行的删除操作。但是还原回flink1.12.1版本出问题了。之前使用的1.11.3版本，导致zookeeper和hdfs存储的是低版本数据，无法升级了，想着删除zookeeper的元数据，但是进去后发现flink相关的数据，啥也没有，怎么会这么奇怪呢？</p><p>迫不得已，新建了一个zookeeper，才让flink1.12.1启动起来了，然后修改了connector的源码打上日志信息，但是日志也没打印出来，啊啊啊啊啊啊啊啊啊啊，到底是走的哪里呢，但是奇迹出现了，之前的问题突然消失了，flink能正常删除hbase数据了，而且没有版本问题，神奇。<br>最后分析了一下，hbase的使用zookeeper，主要是来分配region和regionserver监控的，flink使用zookeeper，主要记录任务的运行状况和checkpoint信息，当checkpoint信息在zookeeper中存储出现问题的时候，删除自然会出问题了。<br>所以最后的解决方案是，为flink重新配了一个zookeeper。</p><p>ok，完成。</p><hr><p><b>书山有路勤为径，学海无涯苦作舟。</b></p><p>欢迎关注我的微信公众号，比较喜欢分享知识，也喜欢宠物，所以做了这2个公众号：<br>程序员写书<br><img src="/images/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%86%99%E4%B9%A6%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BA%8C%E7%BB%B4%E7%A0%81.jpg" alt="程序员写书"><br>电巴克宠物<br><img src="/images/%E7%94%B5%E5%B7%B4%E5%85%8B%E5%AE%A0%E7%89%A9Pets%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BA%8C%E7%BB%B4%E7%A0%81.png" alt="电巴克宠物"><br>一起学习，一起进步。<br></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-6592717531467819",enable_page_level_ads:!0})</script><script data-ad-client="ca-pub-6592717531467819" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Flink/" rel="tag"><i class="fa fa-tag"></i> Flink</a> <a href="/tags/Hbase/" rel="tag"><i class="fa fa-tag"></i> Hbase</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2021/07/03/Springboot%E8%AE%BF%E9%97%AE%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90Html/" rel="next" title="Springboot访问静态资源Html"><i class="fa fa-chevron-left"></i> Springboot访问静态资源Html</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2021/07/24/Flink%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E4%B9%8B%E4%BB%BB%E5%8A%A1%E6%8F%90%E4%BA%A4%E6%A8%A1%E5%BC%8F/" rel="prev" title="Flink实时数仓之任务部署模式">Flink实时数仓之任务部署模式 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a> <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a> <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a> <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a> <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a> <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a> <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a> <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a> <a href="#" class="bds_more" data-cmd="more"></a> <a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="//bdimg.share.baidu.com/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name"></p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">436</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">206</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">487</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/chenzuoli" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:chenzuoli709@163.com" target="_blank" title="G-Mail"><i class="fa fa-fw fa-envelope"></i>G-Mail</a> </span><span class="links-of-author-item"><a href="https://plus.google.com/107350128873508779089" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i>Google</a> </span><span class="links-of-author-item"><a href="https://twitter.com/chenzuoli709" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i>Twitter</a> </span><span class="links-of-author-item"><a href="https://weibo.com/3255051645/profile?rightmod=1&wvr=6&mod=personinfo" target="_blank" title="Sina"><i class="fa fa-fw fa-weibo"></i>Sina</a> </span><span class="links-of-author-item"><a href="https://www.facebook.com/zuoli.chen.58" target="_blank" title="FB"><i class="fa fa-fw fa-facebook"></i>FB</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/chenzuoli" target="_blank" title="CSDN"><i class="fa fa-fw fa-csdn"></i>CSDN</a> </span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/nihaoshijie709918" target="_blank" title="ZhiHu"><i class="fa fa-fw fa-zhihu"></i>ZhiHu</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83"><span class="nav-number">1.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">2.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">3.</span> <span class="nav-text">解决方案</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright" style="text-align:center">&copy; 2017 &mdash; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">petcage</span> <a target="_blank" rel="noopener" href="http://www.miitbeian.gov.cn/">&nbsp;&nbsp;&nbsp;&nbsp;京ICP备18009781号</a></div><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <span id="links1">&nbsp;&nbsp;&nbsp;<a target="_blank" rel="noopener" href="http://lezhifu.cc">乐知付加密平台</a></span><script>var now=new Date;function createtime(){var n=new Date("12/19/2017 13:14:21");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="本站已安全运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",250)</script><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i> 访问人数 <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="site-pv"><i class="fa fa-eye"></i> 浏览次数 <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script><script type="text/javascript">var isfetched=!1,isXml=!0,search_path="search.xml",path=(0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1),"/"+search_path),onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")};function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var searchFunc=function(t,s,a){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");function e(){var e,m=n.value.trim().toLowerCase(),x=m.split(/[\s\-]+/),w=(1<x.length&&x.push(m),[]);0<m.length&&o.forEach(function(t){var e=!1,o=0,h=0,n=t.title.trim(),r=n.toLowerCase(),s=t.content.trim().replace(/<[^>]+>/g,""),a=s.toLowerCase(),i=decodeURIComponent(t.url),c=[],l=[];if(""!=n&&(x.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r,s=0,a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(r=e.indexOf(t,s));)a.push({position:r,word:t}),s=r+n;return a}c=c.concat(e(t,r,!1)),l=l.concat(e(t,a,!1))}),0<c.length||0<l.length)&&(e=!0,o=c.length+l.length),e){function p(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===m&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}[c,l].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});for(var t=[],u=(0!=c.length&&t.push(p(0,0,n.length,c)),[]);0!=l.length;){var f=l[l.length-1],d=f.position,f=f.word,g=d-20,v=d+80;g<0&&(g=0),(v=v<d+f.length?d+f.length:v)>s.length&&(v=s.length),u.push(p(0,g,v,l))}u.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});e=parseInt("1");function $(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}0<=e&&(u=u.slice(0,e));var C="";C+=0!=t.length?"<li><a href='"+i+"' class='search-result-title'>"+$(n,t[0])+"</a>":"<li><a href='"+i+"' class='search-result-title'>"+n+"</a>",u.forEach(function(t){C+="<a href='"+i+'\'><p class="search-result">'+$(s,t)+"...</p></a>"}),C+="</li>",w.push({item:C,searchTextCount:h,hitCount:o,id:w.length})}}),1===x.length&&""===x[0]?r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>':0===w.length?r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>':(w.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id}),e='<ul class="search-result-list">',w.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e)}var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(s),r=document.getElementById(a);n.addEventListener("input",e),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("YJgpFR6aBjuB1wPKjFFRp443-MdYXbMMI","r8fnn6zRKLkDw1iaEe8g3qwb")</script><script>function showTime(e){var e=new AV.Query(e),l=[],c=$(".leancloud_visitors");c.each(function(){l.push($(this).attr("id").trim())}),e.containedIn("url",l),e.find().done(function(e){var t=".leancloud-visitors-count";if(0===e.length)c.find(t).text(0);else{for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),o=o.get("time"),s=document.getElementById(i);$(s).find(t).text(o)}for(n=0;n<l.length;n++){var i=l[n],s=document.getElementById(i),r=$(s).find(t);""==r.text()&&r.text(0)}}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(n){var e=$(".leancloud_visitors"),o=e.attr("id").trim(),i=e.attr("data-flag-title").trim(),e=new AV.Query(n);e.equalTo("url",o),e.find({success:function(e){var t;0<e.length?((e=e[0]).fetchWhenSave(!0),e.increment("time"),e.save(null,{success:function(e){$(document.getElementById(o)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})):(e=new n,(t=new AV.ACL).setPublicReadAccess(!0),t.setPublicWriteAccess(!0),e.setACL(t),e.set("title",i),e.set("url",o),e.set("time",1),e.save(null,{success:function(e){$(document.getElementById(o)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}}))},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0],e=(t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",document.getElementsByTagName("script")[0]);e.parentNode.insertBefore(t,e)}()</script><script type="text/javascript" src="/js/src/love.js"></script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script><script>AV.initialize("YJgpFR6aBjuB1wPKjFFRp443-MdYXbMMI","r8fnn6zRKLkDw1iaEe8g3qwb")</script><script>function showTime(e){var t=new AV.Query(e);$(".leancloud_visitors").each(function(){var o=$(this).attr("id").trim();t.equalTo("url",o),t.find({success:function(e){if(0==e.length)n="0 "+$(document.getElementById(o)).text(),$(document.getElementById(o)).text(n);else for(var t=0;t<e.length;t++){var n=e[t].get("time")+" "+$(document.getElementById(o)).text();$(document.getElementById(o)).text(n)}},error:function(e,t){console.log("Error: "+t.code+" "+t.message)}})})}function addCount(t){var t=AV.Object.extend("Counter"),e=(url=$(".leancloud_visitors").attr("id").trim(),title=$(".leancloud_visitors").attr("data-flag-title").trim(),new AV.Query(t));e.equalTo("url",url),e.find({success:function(e){0<e.length?((e=e[0]).fetchWhenSave(!0),e.increment("time"),e.save(null,{success:function(e){e=e.get("time")+" "+$(document.getElementById(url)).text();$(document.getElementById(url)).text(e)},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})):((e=new t).set("title",title),e.set("url",url),e.set("time",1),e.save(null,{success:function(e){console.log("newcounter.get('time')="+e.get("time"));e=e.get("time")+" "+$(document.getElementById(url)).text();$(document.getElementById(url)).text(e)},error:function(e,t){console.log("Failed to create")}}))},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!0},react:{opacity:.7}})</script></body></html>